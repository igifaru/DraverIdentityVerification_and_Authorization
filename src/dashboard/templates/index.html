<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Control Room</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>

<body>

    <!-- =================== SIDEBAR =================== -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand">DRI<em>VER</em></div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section-label">Navigation</div>

            <button class="nav-item active" id="nav-dashboard" onclick="switchView('dashboard')">
                <i class="fas fa-chart-line"></i>
                <span>Operations</span>
            </button>

            <button class="nav-item" id="nav-enrollment" onclick="switchView('enrollment')">
                <i class="fas fa-user-plus"></i>
                <span>Enrollment</span>
            </button>

            <button class="nav-item" id="nav-audit" onclick="switchView('audit')">
                <i class="fas fa-shield-halved"></i>
                <span>Audit Logs</span>
            </button>

            <button class="nav-item" id="nav-drivers" onclick="switchView('drivers')">
                <i class="fas fa-id-card"></i>
                <span>Manage Drivers</span>
            </button>
        </nav>

        <div class="sidebar-footer">
            <div class="node-pill">
                <div class="node-pill-label">Authorized Node</div>
                <div class="node-pill-value">{{ system_id }}</div>
            </div>
        </div>
    </aside>

    <!-- =================== MAIN STAGE =================== -->
    <main class="main-stage">

        <!-- Top bar -->
        <header class="top-bar">
            <div class="page-title" id="viewTitle">Operations Center</div>

            <div class="top-bar-right">

                <div class="sys-chip stopped" id="sysChip">
                    <span class="dot"></span>
                    <span id="sysChipLabel">System Idle</span>
                </div>

                <!-- Theme toggle -->
                <button class="btn-theme" id="btnTheme" title="Toggle light / dark mode" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>

                <a href="{{ url_for('auth.logout') }}" class="btn-signout">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </a>
            </div>
        </header>

        <!-- Scroll container for all views -->
        <div class="scroll-area">

            <!-- ========== VIEW: OPERATIONS DASHBOARD ========== -->
            <div id="viewDashboard" class="view active">

                <!-- Enrollment metric cards -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label"><i class="fas fa-users"
                                style="margin-right:6px;color:var(--accent);"></i>Total Enrolled</div>
                        <div class="metric-value" id="valTotal">—</div>
                        <div class="metric-sub" id="subTotal">All registered drivers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label"><i class="fas fa-user-check"
                                style="margin-right:6px;color:var(--ok);"></i>Active Drivers</div>
                        <div class="metric-value" id="valActive">—</div>
                        <div class="metric-sub ok" id="subActive">Ready for verification</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label"><i class="fas fa-user-slash"
                                style="margin-right:6px;color:var(--text-muted);"></i>Inactive</div>
                        <div class="metric-value" id="valInactive">—</div>
                        <div class="metric-sub" id="subInactive">Suspended / removed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label"><i class="fas fa-calendar-plus"
                                style="margin-right:6px;color:var(--accent);"></i>Enrolled Today</div>
                        <div class="metric-value" id="valToday">—</div>
                        <div class="metric-sub" id="subToday">New enrollments</div>
                    </div>
                </div>

                <!-- Two-column layout: recent enrollments + category breakdown -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

                    <!-- Category breakdown -->
                    <div class="panel" style="margin-bottom:0;">
                        <div class="panel-head">
                            <h3><i class="fas fa-id-card" style="margin-right:8px;color:var(--accent);"></i>Category
                                Breakdown</h3>
                        </div>
                        <div id="categoryBreakdown" style="padding:4px 0;">
                            <div style="color:var(--text-muted);font-size:0.85rem;padding:8px 0;">Loading…</div>
                        </div>
                    </div>

                    <!-- System readiness -->
                    <div class="panel" style="margin-bottom:0;">
                        <div class="panel-head">
                            <h3><i class="fas fa-shield-halved"
                                    style="margin-right:8px;color:var(--accent);"></i>Enrollment Phase Status</h3>
                        </div>
                        <div id="readinessList" style="padding:4px 0;">
                            <div style="color:var(--text-muted);font-size:0.85rem;padding:8px 0;">Loading…</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Enrollments -->
                <div class="panel">
                    <div class="panel-head">
                        <h3><i class="fas fa-clock-rotate-left" style="margin-right:8px;color:var(--accent);"></i>Recent
                            Enrollments</h3>
                        <span class="badge badge-muted" id="enrollCount">0 records</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Licence</th>
                                <th>Categories</th>
                                <th>Enrolled</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentEnrollTbody">
                            <tr>
                                <td colspan="6" class="table-empty">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
            <!-- /VIEW: DASHBOARD -->

            <!-- ========== VIEW: MANAGE DRIVERS ========== -->
            <div id="viewDrivers" class="view">
                <div class="page-header">
                    <h1>Manage Drivers</h1>
                    <p>View, edit or remove enrolled drivers. Changes take effect immediately.</p>
                </div>

                <div class="panel">
                    <div class="panel-head">
                        <h3>Enrolled Drivers</h3>
                        <span class="badge badge-muted" id="driverCount">0 drivers</span>
                    </div>
                    <table class="data-table" id="driversTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Licence</th>
                                <th>Categories</th>
                                <th>Enrolled</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driversTbody">
                            <tr>
                                <td colspan="7" class="table-empty">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- /VIEW: MANAGE DRIVERS -->

            <!-- ========== VIEW: ENROLLMENT ========== -->
            <div id="viewEnrollment" class="view">
                <div class="page-header">
                    <h1>Biometric Enrollment</h1>
                    <p>Register new authorized personnel. The system captures 5 diverse biometric samples automatically.
                    </p>
                </div>

                <div class="panel">
                    <div class="enroll-grid">

                        <!-- Left: form -->
                        <div>
                            <div class="field-label">Full Legal Name</div>
                            <input type="text" class="text-input" id="enrollName" placeholder="e.g. Jane Smith">

                            <div class="field-label">Driver License Number</div>
                            <input type="text" class="text-input" id="enrollID" placeholder="e.g. DL-0012345">

                            <div class="field-label mt">
                                Categories
                                <span
                                    style="text-transform:none;letter-spacing:0;font-weight:400;color:var(--text-muted);margin-left:6px;">(select
                                    all that apply)</span>
                            </div>
                            <div class="cat-group" id="categoryGroup">
                                <label class="cat-item">
                                    <input type="checkbox" name="driverCategory" value="B">
                                    <span class="cat-box"></span>
                                    <span class="cat-code">B</span>
                                    <span class="cat-name">Passenger cars (standard)</span>
                                </label>
                                <label class="cat-item">
                                    <input type="checkbox" name="driverCategory" value="C">
                                    <span class="cat-box"></span>
                                    <span class="cat-code">C</span>
                                    <span class="cat-name">Trucks / heavy goods</span>
                                </label>
                                <label class="cat-item">
                                    <input type="checkbox" name="driverCategory" value="D">
                                    <span class="cat-box"></span>
                                    <span class="cat-code">D</span>
                                    <span class="cat-name">Buses / passenger transport</span>
                                </label>
                                <label class="cat-item">
                                    <input type="checkbox" name="driverCategory" value="E">
                                    <span class="cat-box"></span>
                                    <span class="cat-code">E</span>
                                    <span class="cat-name">Articulated / special vehicles</span>
                                </label>
                                <label class="cat-item">
                                    <input type="checkbox" name="driverCategory" value="F">
                                    <span class="cat-box"></span>
                                    <span class="cat-code">F</span>
                                    <span class="cat-name">Tractors and agricultural machinery</span>
                                </label>
                            </div>

                            <button class="btn btn-primary" id="btnStart2"
                                style="width:100%;padding:14px;justify-content:center;margin-top:8px;"
                                onclick="startEnrollmentWorkflow()">
                                <i class="fas fa-camera"></i> Start Enrollment
                            </button>
                            <div class="enroll-msg" id="enrollMsg"></div>
                        </div>

                        <!-- Right: camera preview -->
                        <div style="display:flex;flex-direction:column;align-items:center;">
                            <div class="capture-frame" id="captureFrame">
                                <img id="enrollPreview" style="width:100%;height:100%;object-fit:cover;display:none;"
                                    alt="Capture preview">
                                <div class="capture-placeholder" id="enrollPlaceholder">
                                    <i class="fas fa-camera"></i>
                                    <span>Ready for capture</span>
                                </div>
                                <div class="capture-progress" id="captureProgress"></div>
                            </div>
                            <div class="sample-counter" id="captureStatus">Sample 0 / 5</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /VIEW: ENROLLMENT -->

            <!-- ========== VIEW: AUDIT LOGS ========== -->
            <div id="viewAudit" class="view">
                <div class="page-header">
                    <h1>System Audit Logs</h1>
                    <p>Full traceability of all administrative and security events.</p>
                </div>

                <div class="panel">
                    <!-- Toolbar: filter + actions -->
                    <div
                        style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:0 0 16px 0;border-bottom:1px solid var(--border);margin-bottom:16px;">
                        <!-- Search -->
                        <div style="position:relative;flex:1;min-width:180px;">
                            <i class="fas fa-search"
                                style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:0.8rem;"></i>
                            <input type="text" id="auditSearch" placeholder="Search logs…"
                                style="width:100%;padding:7px 10px 7px 30px;border-radius:8px;border:1px solid var(--border-mid);background:var(--bg-raised);color:var(--text);font-size:0.83rem;outline:none;"
                                oninput="filterAuditLogs()">
                        </div>
                        <!-- Action filter -->
                        <select id="auditActionFilter"
                            style="padding:7px 12px;border-radius:8px;border:1px solid var(--border-mid);background:var(--bg-raised);color:var(--text);font-size:0.83rem;cursor:pointer;outline:none;"
                            onchange="fetchAuditLogs()">
                            <option value="">All actions</option>
                            <option value="LOGIN">LOGIN</option>
                            <option value="LOGOUT">LOGOUT</option>
                            <option value="ENROLL_DRIVER">ENROLL_DRIVER</option>
                            <option value="DELETE_DRIVER">DELETE_DRIVER</option>
                            <option value="UPDATE_DRIVER">UPDATE_DRIVER</option>
                            <option value="DELETE_AUDIT_LOG">DELETE_AUDIT_LOG</option>
                            <option value="CLEAR_AUDIT_LOGS">CLEAR_AUDIT_LOGS</option>
                        </select>
                        <!-- Record count -->
                        <span class="badge badge-muted" id="auditCountBadge" style="white-space:nowrap;">0
                            records</span>
                        <!-- Spacer -->
                        <div style="flex:1;"></div>
                        <!-- Clear All -->
                        <button class="btn btn-danger" id="btnClearAudit"
                            style="gap:6px;padding:7px 14px;font-size:0.82rem;" onclick="clearAuditLogs()">
                            <i class="fas fa-trash-can"></i> Clear All
                        </button>
                    </div>

                    <div class="audit-list" id="auditList">
                        <div class="audit-empty">Loading audit records…</div>
                    </div>
                </div>
            </div>
            <!-- /VIEW: AUDIT -->

        </div><!-- /scroll-area -->
    </main>

    <!-- Edit Driver Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div class="modal-title"><i class="fas fa-user-edit" style="color:var(--accent);margin-right:8px;"></i>Edit
                Driver</div>

            <input type="hidden" id="editDriverId">

            <div class="field-label">Full Legal Name</div>
            <input type="text" class="text-input" id="editName" placeholder="Full name">

            <div class="field-label">Licence Number</div>
            <input type="text" class="text-input" id="editLicense" placeholder="Licence number">

            <div class="field-label mt">Categories</div>
            <div class="cat-group" id="editCatGroup">
                <label class="cat-item"><input type="checkbox" name="editCat" value="A"><span
                        class="cat-box"></span><span class="cat-code">A</span><span class="cat-name">Motorcycles &amp;
                        light vehicles</span></label>
                <label class="cat-item"><input type="checkbox" name="editCat" value="B"><span
                        class="cat-box"></span><span class="cat-code">B</span><span class="cat-name">Passenger cars
                        (standard)</span></label>
                <label class="cat-item"><input type="checkbox" name="editCat" value="C"><span
                        class="cat-box"></span><span class="cat-code">C</span><span class="cat-name">Trucks / heavy
                        goods</span></label>
                <label class="cat-item"><input type="checkbox" name="editCat" value="D"><span
                        class="cat-box"></span><span class="cat-code">D</span><span class="cat-name">Buses / passenger
                        transport</span></label>
                <label class="cat-item"><input type="checkbox" name="editCat" value="E"><span
                        class="cat-box"></span><span class="cat-code">E</span><span class="cat-name">Articulated /
                        special vehicles</span></label>
            </div>

            <div class="field-label mt">Status</div>
            <select class="text-input" id="editStatus" style="cursor:pointer;">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>

            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDriverEdit()"><i class="fas fa-save"></i> Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast container (fixed bottom-right) -->
    <div id="toastContainer"></div>

    <!-- =================== JAVASCRIPT =================== -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

</body>

</html>
